"""
–ú–æ–¥—É–ª—å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∫–∞—Ä—Ç —Ç–∞—Ä–æ
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
"""
from typing import Optional, Dict
import aiohttp
import logging

logger = logging.getLogger(__name__)


# –ë–∞–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∫–∞—Ä—Ç —Ç–∞—Ä–æ (–æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –¥–æ—Å—Ç–æ—è–Ω–∏–µ)
# –ò—Å–ø–æ–ª—å–∑—É–µ–º —ç–º–æ–¥–∑–∏ –∫–∞–∫ fallback, –Ω–æ –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

# –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π API –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ç–∞—Ä–æ
# tarot-api-server.onrender.com –∏–ª–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
TAROT_API_BASE = "https://tarot-api-server.onrender.com/api/cards"

# Fallback API –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
FALLBACK_API = "https://api.lostmy.name/tarot"

# Mapping —Ä—É—Å—Å–∫–∏—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –∫ –∞–Ω–≥–ª–∏–π—Å–∫–∏–º (–¥–ª—è API)
CARD_NAME_MAPPING = {
    "–î—É—Ä–∞–∫": "fool",
    "–ú–∞–≥": "magician",
    "–ñ—Ä–∏—Ü–∞": "high-priestess",
    "–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞": "empress",
    "–ò–º–ø–µ—Ä–∞—Ç–æ—Ä": "emperor",
    "–ò–µ—Ä–æ—Ñ–∞–Ω—Ç": "hierophant",
    "–í–ª—é–±–ª–µ–Ω–Ω—ã–µ": "lovers",
    "–ö–æ–ª–µ—Å–Ω–∏—Ü–∞": "chariot",
    "–°–∏–ª–∞": "strength",
    "–û—Ç—à–µ–ª—å–Ω–∏–∫": "hermit",
    "–ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã": "wheel-of-fortune",
    "–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å": "justice",
    "–ü–æ–≤–µ—à–µ–Ω–Ω—ã–π": "hanged-man",
    "–°–º–µ—Ä—Ç—å": "death",
    "–£–º–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å": "temperance",
    "–î—å—è–≤–æ–ª": "devil",
    "–ë–∞—à–Ω—è": "tower",
    "–ó–≤–µ–∑–¥–∞": "star",
    "–õ—É–Ω–∞": "moon",
    "–°–æ–ª–Ω—Ü–µ": "sun",
    "–°—É–¥": "judgement",
    "–ú–∏—Ä": "world",
}


async def get_tarot_image_from_api(card_name: str) -> Optional[str]:
    """
    –ü–æ–ª—É—á–∏—Ç—å URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ä—Ç—ã –∏–∑ API
    
    Returns:
        URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ None –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
    """
    try:
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ä—É—Å—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ –∞–Ω–≥–ª–∏–π—Å–∫–æ–µ –¥–ª—è API
        api_name = CARD_NAME_MAPPING.get(card_name, card_name.lower().replace(" ", "-"))
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π GitHub CDN —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ —Ç–∞—Ä–æ
        # –ü—Ä–∏–º–µ—Ä: https://raw.githubusercontent.com/ekelen/tarot-api/master/images/{card}
        
        # –ü—Ä–æ–±—É–µ–º –ø–µ—Ä–≤—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ - –ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ GitHub
        github_url = f"https://raw.githubusercontent.com/ekelen/tarot-api/master/images/{api_name}.jpg"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        async with aiohttp.ClientSession() as session:
            async with session.get(github_url, timeout=aiohttp.ClientTimeout(total=3)) as response:
                if response.status == 200:
                    return github_url
        
        # –ï—Å–ª–∏ GitHub –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None
        return None
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è {card_name}: {e}")
        return None


# –°–ª–æ–≤–∞—Ä—å —Å –ø—Ä—è–º—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ä—Ç —Ç–∞—Ä–æ
# –≠—Ç–∏ —Å—Å—ã–ª–∫–∏ –≤–µ–¥—É—Ç –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
TAROT_IMAGE_URLS = {
    # –°—Ç–∞—Ä—à–∏–µ –∞—Ä–∫–∞–Ω—ã - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–π API
    "–î—É—Ä–∞–∫": None,  # –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —ç–º–æ–¥–∑–∏ üÉè
    "–ú–∞–≥": None,
    # –î–æ–±–∞–≤—å—Ç–µ URL –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
}


def get_card_image_url(card_name: str, is_reversed: bool = False) -> str:
    """
    –ü–æ–ª—É—á–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —ç–º–æ–¥–∑–∏ –∫–∞–∫ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
    –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    """
    image_emojis = {
        # –°—Ç–∞—Ä—à–∏–µ –∞—Ä–∫–∞–Ω—ã
        "–î—É—Ä–∞–∫": "üÉè",
        "–ú–∞–≥": "ü™Ñ",
        "–ñ—Ä–∏—Ü–∞": "üîÆ",
        "–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞": "üëë",
        "–ò–º–ø–µ—Ä–∞—Ç–æ—Ä": "‚öîÔ∏è",
        "–ò–µ—Ä–æ—Ñ–∞–Ω—Ç": "üìø",
        "–í–ª—é–±–ª–µ–Ω–Ω—ã–µ": "üíï",
        "–ö–æ–ª–µ—Å–Ω–∏—Ü–∞": "üèÅ",
        "–°–∏–ª–∞": "üí™",
        "–û—Ç—à–µ–ª—å–Ω–∏–∫": "üïØÔ∏è",
        "–ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã": "‚ôªÔ∏è",
        "–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å": "‚öñÔ∏è",
        "–ü–æ–≤–µ—à–µ–Ω–Ω—ã–π": "‚è≥",
        "–°–º–µ—Ä—Ç—å": "üíÄ",
        "–£–º–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å": "üßò",
        "–î—å—è–≤–æ–ª": "üòà",
        "–ë–∞—à–Ω—è": "üóº",
        "–ó–≤–µ–∑–¥–∞": "‚≠ê",
        "–õ—É–Ω–∞": "üåô",
        "–°–æ–ª–Ω—Ü–µ": "‚òÄÔ∏è",
        "–°—É–¥": "üëÅÔ∏è",
        "–ú–∏—Ä": "üåç",
    }
    
    # –≠–º–æ–¥–∑–∏ –¥–ª—è –º–∞—Å—Ç–µ–π
    suit_emojis = {
        "–ñ–µ–∑–ª–æ–≤": "üî•",
        "–ö—É–±–∫–æ–≤": "üíß",
        "–ú–µ—á–µ–π": "‚öîÔ∏è",
        "–ü–µ–Ω—Ç–∞–∫–ª–µ–π": "üí∞"
    }
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —ç–º–æ–¥–∑–∏ –¥–ª—è –∫–∞—Ä—Ç—ã
    emoji = image_emojis.get(card_name, "üÉè")
    
    # –ï—Å–ª–∏ —ç—Ç–æ –º–∞—Å—Ç—å, –¥–æ–±–∞–≤–ª—è–µ–º —ç–º–æ–¥–∑–∏ –º–∞—Å—Ç–∏
    for suit, suit_emoji in suit_emojis.items():
        if suit in card_name:
            emoji = suit_emoji
            break
    
    # –î–ª—è –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–æ–π –∫–∞—Ä—Ç—ã –¥–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
    if is_reversed:
        emoji = f"üî¥ {emoji}"
    else:
        emoji = f"üü¢ {emoji}"
    
    return emoji


def get_card_full_info(card: Dict, is_reversed: bool) -> str:
    """
    –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞—Ä—Ç–µ —Å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π
    """
    card_name = card["name"]
    emoji = get_card_image_url(card_name, is_reversed)
    
    status = "–ü–ï–†–ï–í–ï–†–ù–£–¢–ê" if is_reversed else "–ü–†–Ø–ú–ê–Ø"
    
    info = f"""
{emoji} *{card_name}*
–ü–æ–∑–∏—Ü–∏—è: {status}

"""
    
    return info


# –î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:
# 1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –ø–∞–ø–∫—É images/tarot/
# 2. –î–æ–±–∞–≤—å—Ç–µ URL –≤ —Å–ª–æ–≤–∞—Ä—å TAROT_IMAGE_URLS
# 3. –û–±–Ω–æ–≤–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é get_card_image_url –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ URL
#
# –ü—Ä–∏–º–µ—Ä:
# def get_card_image_url(card_name: str, is_reversed: bool = False) -> Optional[str]:
#     if card_name in TAROT_IMAGE_URLS:
#         return TAROT_IMAGE_URLS[card_name]
#     return None  # –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —ç–º–æ–¥–∑–∏

def send_card_with_image(bot, chat_id: int, card: Dict, is_reversed: bool, text: str):
    """
    –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—É —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
    
    –ï—Å–ª–∏ –µ—Å—Ç—å URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ
    –ï—Å–ª–∏ –Ω–µ—Ç - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç —Å —ç–º–æ–¥–∑–∏
    """
    card_name = card["name"]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    if card_name in TAROT_IMAGE_URLS:
        image_url = TAROT_IMAGE_URLS[card_name]
        # TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ bot.send_photo()
        # await bot.send_photo(chat_id=chat_id, photo=image_url, caption=text)
        return text  # –í—Ä–µ–º–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
    else:
        return text

